## SPDX-License-Identifier: GPL-3.0-or-later
## Copyright (C) 2020 Tobias Hunger <tobias.hunger@gmail.com>

---
name: Build a bootstrap environment for GNG

on:
  workflow_dispatch:
  schedule:
    - cron: "42 2 * * *"

jobs:
  install-nix-user-env:
    runs-on: ubuntu-latest
    steps:
      - name: "Download nix-user-chroot"
        uses: robinraju/release-downloader@v1.5
        with:
          repository: "nix-community/nix-user-chroot"
          latest: true
          fileName: "nix-user-chroot-bin-*-x86_64-unknown-linux-musl"
          out-file-path: "."
      - name: Set up basic nix environment
        run: |
          ls -alF
          mv nix-user-chroot* nix-user-chroot
          ls -alF
          mkdir tmp-home
          mkdir nix
          export HOME="$(pwd)/tmp-home"
          export NIX="$(pwd)/nix"
          ./nix-user-chroot "${NIX}" bash -c "curl -L https://nixos.org/nix/install | bash"
          ./nix-user-chroot "${NIX}" bash -c "source \"${HOME}/.nix-profile/etc/profile.d/nix.sh\" && nix-env -p \"${NIX}/var/nix/profiles/bootstrap\" -iA nixpkgs.bash nixpkgs.bison nixpkgs.coreutils nixpkgs.diffutils nixpkgs.file nixpkgs.findutils nixpkgs.gawk nixpkgs.gcc nixpkgs.gettext nixpkgs.gnugrep nixpkgs.gnum4 nixpkgs.gnumake nixpkgs.gnused nixpkgs.patch nixpkgs.perl nixpkgs.python3 nixpkgs.texinfo nixpkgs.util-linux"
      - name: Upload nix store
        uses: actions/upload-artifact@v2
        with:
          name: bootstrap-nix
          path: nix
